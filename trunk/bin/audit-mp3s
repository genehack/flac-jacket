#! /usr/bin/perl 

# $Id$
# $URL$

use strict;
use warnings;

use MP3::Info;

my $DEBUG   = 0;
my $MP3_DIR = '/music/mp3';

my @frames = qw/ TIT2 TPE1 TYER TRCK TALB TCON /;

use_winamp_genres();

foreach my $artist ( <$MP3_DIR/*> ) {
  print "[ DEBUG ] $artist\n" if $DEBUG;

  unless( -d $artist ) {
    print "NON-DIRECTORY: $artist\n";
    next;
  }
  
  chdir( $artist );

  my @words = split / / , $artist;
 WORD: foreach( @words ) {
    if( /^[a-z]/ ) {
      print "$artist contains a lowercase word\n";
      last WORD;
    }
  }

  foreach my $album( <*> ) {
    print "[ DEBUG ] \t$album\n" if $DEBUG;

    unless( -d $album ) {
      print "$artist/$album is not a directory\n";
      next;
    }
    
    unless( -e "$album/cover.jpg" ) {
      print "$artist/$album lacks cover.jpg\n";
    }

    if( $album =~ /^A Compilation Of Warped Music II/ ) {
      print "$artist/$album needs to be renamed\n";
    }
    
    
    if( $album =~ /^CMJ New Music Monthly Vol / ) {
      print "$artist/$album needs to be renamed\n";
    }

    if( $album =~ /Paste / ) {
      print "$artist/$album needs to be renamed\n"
        unless $album =~ /^Paste \d{4}\.\d{2}-\d{2}$/
          or $album =~ /^Paste \d{4}\.\d{2}-\d{4}\.\d{2}$/
          or $album =~ /^Paste \d{4}\.\d{2}$/;
    }
        
    chdir( "$artist/$album" );

    foreach my $track ( <*> ) {
      print "[ DEBUG ] \t\t$track\n" if $DEBUG;

      next if $track eq 'cover.jpg';
      unless( $track =~ /.mp3$/ ) {
        print "NON-COVER/MP3 file: $artist/$album/$track\n";
        next;
      }
                
      my $tag = get_mp3tag( $track , 0 , 2 );

      print "[ DEBUG ] \t\t\t",$tag->{TAGVERSION},"\n" if $DEBUG;
      if( $tag->{TAGVERSION} eq 'ID3v1.1 / ID3v2.3.0' ) {
        print "striping ID3v1 tags from $artist/$album/$track ... \n";
        `id3v2 -s "$track"`;
      }
      elsif( $tag->{TAGVERSION} ne 'ID3v2.3.0' ) {
        print "$artist/$album/$track has non-ID3v2 tags ($tag->{TAGVERSION})\n";
      }

      if( $tag->{TSSE} ) {
        print "Removing encoding tag from $artist/$album/$track ... \n";
        `id3v2 -2 --TSSE '' "$track"`;
      }

      if( my $album = $tag->{TALB} ) {
        if( $album =~ /^CMJ New Music Monthly Vol/ ) {
          print "$artist/$album/$track album tag ('$album') needs to be fixed.\n";
        }
        if( $album =~ /^Paste / ) {
          print "$artist/$album/$track album tag ('$album') needs to be fixed.\n"
            unless $album =~ /^Paste \d{4}\.\d{2}-\d{2}$/
              or $album =~ /^Paste \d{4}\.\d{2}-\d{4}\.\d{2}$/
              or $album =~ /^Paste \d{4}\.\d{2}$/;
        }
      }
            
      foreach( @frames ) {
        print "[ DEBUG ] \t\t\t$_ --> $tag->{$_}\n" if $DEBUG;
        unless( $tag->{$_} ) {
          print "$artist/$album/$track lacks $_ frame\n";
        }
      }
      
    }
    chdir( $artist );
  }
  <STDIN> if $DEBUG;
}

        
